<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"/>
  <title>Drip Club ‚Äî Shop</title>
  <script src="https://tg.dev/js/telegram-web-app.js?7"></script>
  <style>
    :root{
      /* Dark (default) ‚Äî luxury palette */
      --bg:#05060a; --card:#0b0d13; --stroke:rgba(255,255,255,.06);
      --text:#eef2f7; --muted:#868fa0; --brand:#1c2d4f; --brand2:#d4af37;
      --danger:#ef4444; --ok:#10b981; --r:18px; --shadow:0 12px 30px rgba(0,0,0,.45);
      /* motion */
      --motion-fast:160ms; --motion-medium:200ms;
    }
    /* Light theme overrides ‚Äî will be applied when [data-theme="light"] on <html> */
    html[data-theme="light"]{
      --bg: #fbfdff; --card:#ffffff; --stroke:rgba(3,7,18,.06);
      --text:#071428; --muted:#52606d; --brand:#5b21b6; --brand2:#0ea5e9;
      --danger:#b91c1c; --ok:#047857; --shadow:0 8px 30px rgba(10,14,20,0.06);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{
      margin:0;color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Inter,Arial;
      /* mostly solid background with a subtle vignette */
      background: linear-gradient(180deg, rgba(0,0,0,0.06), transparent), var(--bg);
    }
    .app{max-width:760px;margin:0 auto;padding:12px 12px 96px}
    header{position:sticky;top:0;z-index:30;background:linear-gradient(180deg,rgba(11,12,16,.95),rgba(11,12,16,.6) 60%,transparent);backdrop-filter:blur(8px);padding:10px 8px 6px}
    .row{display:flex;align-items:center;gap:10px}
    .grow{flex:1}
    .title{font-weight:800;letter-spacing:.2px}
    .tabs{display:flex;gap:8px;overflow:auto;padding:6px 2px 0}
    .tab{padding:8px 12px;border:1px solid var(--stroke);border-radius:999px;background:rgba(255,255,255,.03);white-space:nowrap;font-size:14px}
    .tab.active{border-color:rgba(124,92,255,.6);background:linear-gradient(90deg,rgba(124,92,255,.18),rgba(46,166,255,.18))}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .card{background:var(--card);border:1px solid var(--stroke);border-radius:var(--r);overflow:hidden;box-shadow:var(--shadow);transition:box-shadow var(--motion-fast) ease,opacity var(--motion-fast) ease}
  .img{aspect-ratio:4/5;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));display:block;width:100%;object-fit:cover}
  .img.hidden{opacity:0;transform:scale(1.02);transition:opacity var(--motion-fast) ease,transform var(--motion-fast) ease}
  .img:not(.hidden){opacity:1;transform:none}

  /* skeleton shimmer */
  .skeleton{width:100%;height:100%;background:linear-gradient(90deg,rgba(255,255,255,0.02),rgba(255,255,255,0.06),rgba(255,255,255,0.02));background-size:200% 100%;animation:shimmer 1.2s linear infinite}
  @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
  /* skeleton card for loading rows */
  .skeleton-card{background:var(--card);border:1px solid var(--stroke);border-radius:var(--r);padding:8px;display:block}
  .skeleton-card .thumb{height:140px;border-radius:8px;overflow:hidden}
  .skeleton-card .meta{margin-top:8px;height:36px}
  /* focus outlines */
  .filter-chip:focus{outline:2px solid rgba(124,92,255,.6);outline-offset:2px}
  .btn:focus{outline:2px solid rgba(46,166,255,.28);outline-offset:2px}
  /* page route transitions */
  #app{transition:transform var(--motion-medium) ease,opacity var(--motion-medium) ease}
  #app.route-exit{opacity:0;transform:translateY(6px)}
  #app.route-enter{opacity:0;transform:translateY(6px)}
    .pad{padding:10px}
    .brand{font-size:12px;color:var(--muted);letter-spacing:.3px}
    .name{font-size:14px;font-weight:600;line-height:1.3;margin:2px 0 6px}
    .price{font-weight:700}
    .low{color:#f59e0b;font-size:12px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border-radius:12px;border:1px solid var(--stroke);background:linear-gradient(90deg,rgba(124,92,255,.12),rgba(46,166,255,.12));padding:10px 12px;font-weight:600;cursor:pointer}
    .btn.full{width:100%}
    .muted{color:var(--muted)}
    .section{padding:12px}
    .box{background:var(--card);border:1px solid var(--stroke);border-radius:var(--r);padding:12px}
    .row-between{display:flex;justify-content:space-between;align-items:center}
    .pill{padding:6px 10px;border:1px solid var(--stroke);border-radius:999px;color:var(--muted);font-size:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;letter-spacing:.3px}
    .field{display:flex;flex-direction:column;gap:6px;margin:8px 0}
    input,select,textarea{background:#0c1117;border:1px solid var(--stroke);border-radius:12px;padding:12px 12px;color:var(--text);font-size:15px;outline:none}
    .copy{border:1px dashed var(--stroke);border-radius:12px;padding:10px 12px;display:flex;justify-content:space-between;align-items:center;margin:8px 0}
    .copy button{background:#151b23;border:1px solid var(--stroke);color:var(--text);padding:6px 10px;border-radius:10px;cursor:pointer}
    .footerbar{position:fixed;left:0;right:0;bottom:0;z-index:50;padding:8px 12px;background:linear-gradient(0deg,rgba(11,12,16,.98),rgba(11,12,16,.85) 55%,transparent);backdrop-filter:blur(8px)}
    .cartbar{max-width:760px;margin:0 auto;border:1px solid var(--stroke);background:rgba(255,255,255,.03);padding:8px 12px;border-radius:12px;display:flex;justify-content:space-between;align-items:center}
    .link{color:#a5b4fc;text-decoration:none}
    .danger{color:var(--danger)} .ok{color:var(--ok)}
    .list{display:flex;flex-direction:column;gap:10px}
    .qty{display:flex;gap:8px;align-items:center}
    .qty button{width:28px;height:28px;border-radius:8px;border:1px solid var(--stroke);background:#121923;color:var(--text);cursor:pointer}
    .hr{height:1px;background:var(--stroke);margin:10px 0}
    .help{font-size:12px;color:var(--muted);margin-top:6px}

    /* Hero removed for a minimal home layout */

    /* SEARCH */
    .search{display:flex;gap:8px;margin-top:12px}
    .search input{flex:1;border-radius:12px}
    .filters{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .filter-chip{padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:transparent;color:var(--muted);cursor:pointer}
    .filter-chip.active{background:linear-gradient(90deg,rgba(124,92,255,.12),rgba(46,166,255,.12));color:var(--text);border-color:rgba(124,92,255,.28)}
    .chipbar{display:flex;gap:8px;overflow:auto;margin-top:10px}
    .chip{font-size:12px;padding:8px 10px;border:1px solid var(--stroke);border-radius:999px;background:rgba(255,255,255,.03)}

    /* TRUST */
    .trust{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:12px}
    .trust .t{display:flex;gap:8px;align-items:center;border:1px solid var(--stroke);border-radius:12px;padding:10px;background:rgba(255,255,255,.03);font-size:12.5px}

      .recently{display:flex;gap:12px;overflow:auto;margin-top:12px;padding:6px 2px}

    /* logo + category chips */
    .logo{width:24px;height:24px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-weight:800;background:var(--brand2);color:var(--brand);font-size:12px;border:1px solid rgba(255,255,255,0.04)}
    .cat-row{display:flex;gap:8px;overflow:auto;margin-top:12px}
    .cat-chip{padding:8px 12px;border-radius:999px;border:1px solid var(--stroke);background:transparent;color:var(--muted);font-size:13px;cursor:pointer}
    .cat-chip.active{background:var(--brand);border-color:var(--brand2);color:var(--text)}
    .sub-row{display:flex;gap:8px;overflow:auto;margin-top:8px}
    .sub-chip{padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:transparent;color:var(--muted);font-size:12px;cursor:pointer}
    .sub-chip.active{background:var(--brand);border-color:var(--brand2);color:var(--text)}
    /* compact card for recently viewed */
    .compact-card{background:transparent;border-radius:10px;padding:6px}
    /* size swatches */
    .swatches{display:flex;gap:6px;margin:6px 0}
    .swatch{padding:6px 8px;border-radius:8px;border:1px solid var(--stroke);background:transparent;font-size:12px;color:var(--muted)}
    .swatch.disabled{opacity:.38;filter:grayscale(.6);cursor:not-allowed}
    .stock-meter-wrap{margin-top:8px;display:flex;align-items:center;gap:10px}
    .stock-meter{height:8px;background:linear-gradient(90deg,var(--ok),var(--brand));border-radius:999px;width:40%;min-width:28px}
    .stock-label{font-size:12px;color:var(--muted)}
    /* image modal / gallery */
    #imgModal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,4,6,0.8);z-index:120;opacity:0;pointer-events:none;transition:opacity 180ms ease}
    #imgModal.open{opacity:1;pointer-events:auto}
    #imgModal .modal-inner{position:relative;max-width:95%;max-height:95%}
    #imgModal img{max-width:100%;max-height:100%;object-fit:contain;border-radius:12px}
    #imgModal .close{position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.4);border-radius:8px;padding:6px;color:#fff;cursor:pointer}
    #imgModal .prev,#imgModal .next{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.35);padding:10px;border-radius:999px;color:#fff;cursor:pointer}
    #imgModal .prev{left:8px}#imgModal .next{right:8px}
    /* cart drawer */
    #cartDrawer{border-left:1px solid var(--stroke)}
    #cartDrawer.open{transform:translateX(0)}
    #cartDrawer .line{height:1px;background:var(--stroke);margin:8px 0}
    #cartDrawer .item{display:flex;gap:8px;align-items:center;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,.03)}
    #cartDrawer .item .meta{flex:1}
    #holdFooter{font-size:12px;color:var(--muted);margin-left:12px}
  </style>
  <!-- Preload first 6 product images for LCP/perf -->
  <link rel="preload" as="image" href="https://images.unsplash.com/photo-1541099649105-f69ad21f3246?q=80&w=1200&auto=format&fit=crop">
  <link rel="preload" as="image" href="https://images.unsplash.com/photo-1558769132-cb1aea458c5e?q=80&w=1200&auto=format&fit=crop">
  <link rel="preload" as="image" href="https://images.unsplash.com/photo-1542293787938-c9e299b88054?q=80&w=1200&auto=format&fit=crop">
  <link rel="preload" as="image" href="https://images.unsplash.com/photo-1563170423-18f482d82cc8?q=80&w=1200&auto=format&fit=crop">
  <link rel="preload" as="image" href="https://images.unsplash.com/photo-1606229365485-93a3b8ee038e?q=80&w=1200&auto=format&fit=crop">
  <link rel="preload" as="image" href="https://images.unsplash.com/photo-1548883354-7622d03acae1?q=80&w=1200&auto=format&fit=crop">
</head>
<body>
  <div class="app" id="app"></div>

  <div class="footerbar">
    <div class="cartbar mono" id="cartbar" style="display:none;align-items:center;gap:12px;display:flex;justify-content:space-between;">
      <div style="display:flex;gap:8px;align-items:center">
        <div id="cartbar-left">üõí 0 items</div>
        <div id="cartbar-ref" class="muted mono" style="margin-left:8px;display:none"></div>
      </div>
      <div id="cartbar-right">¬£0.00</div>
    </div>
  </div>

  <!-- Mini cart drawer -->
  <div id="cartDrawer" style="position:fixed;right:0;top:0;bottom:0;width:360px;max-width:92%;background:var(--card);box-shadow:-40px 0 80px rgba(0,0,0,.6);transform:translateX(100%);transition:transform 220ms ease;z-index:130;padding:12px;overflow:auto">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <div class="title">Your bag</div>
      <button class="btn" onclick="closeCartDrawer()">Close</button>
    </div>
    <div id="cartDrawerBody"></div>
    <div style="margin-top:12px" id="cartDrawerFooter"></div>
  </div>

  <!-- Image modal for gallery zoom -->
  <div id="imgModal" onclick="closeImageModal()" ontouchstart="galleryTouchStart(event)" ontouchend="galleryTouchEnd(event)">
    <div class="modal-inner" onclick="event.stopPropagation()">
      <button class="close" onclick="closeImageModal()">‚úï</button>
      <button class="prev" onclick="galleryPrev()">‚óÄ</button>
      <img src="" alt="zoom" />
      <button class="next" onclick="galleryNext()">‚ñ∂</button>
    </div>
  </div>

<script>
/* ====== CONFIG ====== */
const BANK = { payee:"DRIP CLUB LTD", sortCode:"04-00-04", accountNo:"12345678", iban:"GB12BARC04000412345678" };
const SUPPORT_LINK = "tg://resolve?domain=YOUR_BOT_USERNAME&start=help";
const PLACEHOLDER_IMG = 'https://via.placeholder.com/900x1200?text=Image+unavailable&bg=efefef&fg=444';

/* ====== DATA ====== */
const CATEGORIES = ["Men","Women","Kids","Accessories","Electronics"];
const SUBCATEGORIES = {
  Men: ["All","Hoodies","T-Shirts","Jumpers","Tracksuits"],
  Women: ["All","Tops","Dresses","Bottoms","Footwear"],
  Kids: ["All","Sets","Hoodies","T-Shirts","Trainers"],
  Accessories: ["All","Bags","Caps","Wallets","Belts"],
  Electronics: ["All","Audio","Wearables","Phone Accessories"]
};
const PRODUCTS = [
  {id:"g1",cat:"Men",type:"Hoodies",brand:"Nike",name:"Tech Fleece Hoodie",price:89.99,stock:3,sizes:["S","M","L"],img:"https://images.unsplash.com/photo-1541099649105-f69ad21f3246?q=80&w=1200&auto=format&fit=crop"},
  {id:"g2",cat:"Men",type:"T-Shirts",brand:"Jordan",name:"Jumpman Tee",price:34.99,stock:12,sizes:["S","M","L","XL"],img:"https://images.unsplash.com/photo-1558769132-cb1aea458c5e?q=80&w=1200&auto=format&fit=crop"},
  {id:"g3",cat:"Women",type:"Bottoms",brand:"Adidas",name:"3-Stripes Leggings",price:29.99,stock:2,sizes:["XS","S","M"],img:"https://images.unsplash.com/photo-1542293787938-c9e299b88054?q=80&w=1200&auto=format&fit=crop"},
  {id:"g4",cat:"Accessories",type:"Fragrances",brand:"Dior",name:"Sauvage 100 ml",price:84.00,stock:6,sizes:["100ml"],img:"https://images.unsplash.com/photo-1563170423-18f482d82cc8?q=80&w=1200&auto=format&fit=crop"},
  {id:"g5",cat:"Electronics",type:"Audio",brand:"Apple",name:"AirPods Pro (2nd Gen)",price:199.00,stock:5,sizes:["‚Äî"],img:"https://images.unsplash.com/photo-1606229365485-93a3b8ee038e?q=80&w=1200&auto=format&fit=crop"},
  {id:"g6",cat:"Men",type:"Jackets",brand:"The North Face",name:"1996 Nuptse",price:249.00,stock:1,sizes:["M","L"],img:"https://images.unsplash.com/photo-1548883354-7622d03acae1?q=80&w=1200&auto=format&fit=crop"}
];
// FEATURED removed ‚Äî no longer used in the UI

/* ====== STATE ====== */
const tg = window.Telegram?.WebApp ?? {MainButton:{},BackButton:{},HapticFeedback:{}};
const state = {
  route:{name:"home",params:{}},
  tab:"Men",
  query:"",
  cart: load("cart", []),
  hold:null,
  user:{ email:"", phone:"", name:"", address:"", city:"", postcode:"", country:"United Kingdom" },
  filters: { size: null, under100: false, inStock: false },
  observer: null,
  order:null
};

/* ====== HELPERS ====== */
const el = s => document.querySelector(s);
// Polyfill requestAnimationFrame for non-browser environments (jsdom/node)
if(typeof requestAnimationFrame === 'undefined'){
  globalThis.requestAnimationFrame = (cb)=> setTimeout(()=>cb(Date.now()), 16);
  globalThis.cancelAnimationFrame = (id)=> clearTimeout(id);
}
const pound = n => "¬£"+(n.toFixed(2));
const sum = xs => xs.reduce((a,b)=>a + b.price*b.qty, 0);
const uid = (len=6)=>Math.random().toString(36).slice(2,2+len).toUpperCase();
const uniqueRef = ()=>"DRIP-"+new Date().toISOString().slice(2,10).replace(/-/g,"")+"-"+uid(6);
function save(k,v){localStorage.setItem(k,JSON.stringify(v));}
function load(k,d){try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}}
function haptic(k="impact"){try{tg.HapticFeedback?.impactOccurred?.(k)}catch{}}
function copy(t,n){navigator.clipboard.writeText(t).then(()=>{if(n){n.innerText="Copied";setTimeout(()=>n.innerText="Copy",900);}haptic("soft");});}
function setMainButton(t,f){tg.MainButton?.show?.();tg.MainButton?.setParams?.({text:t});tg.MainButton?.onClick?.(()=>{});tg.MainButton?.onClick?.(f);}
function hideMain(){tg.MainButton?.hide?.();}
function setBack(s,f){if(s){tg.BackButton?.show?.();tg.BackButton?.onClick?.(()=>f?.());}else{tg.BackButton?.hide?.();tg.BackButton?.onClick?.(()=>{});}}
function updateCartBar(){
  const items = state.cart.reduce((a,b)=>a+b.qty,0);
  const total = sum(state.cart);
  const bar = el('#cartbar');
  // batch DOM writes to avoid layout thrash
  requestAnimationFrame(()=>{
    if(items>0){ bar.style.display='block'; el('#cartbar-left').innerText = `üõí ${items} item${items>1?"s":""}`; el('#cartbar-right').innerText = pound(total); }
    else { bar.style.display='none'; hideMain(); }
    _updateCartBarRef();
  });
}
// show order reference (if available) in the cartbar
function _updateCartBarRef(){ try{ const refEl = el('#cartbar-ref'); if(!refEl) return; const last = state.order?.uniqueRef || load('lastOrder')?.uniqueRef || null; if(last){ refEl.style.display='inline-block'; refEl.innerText = last; } else { refEl.style.display='none'; } }catch(e){} }
// Make cartbar tappable to open mini drawer
document.addEventListener('click', (e)=>{
  const cb = el('#cartbar'); if(!cb) return;
  // if click inside cartbar open drawer
  if(cb.contains(e.target)){ openCartDrawer(); }
}, {capture:true});

function openCartDrawer(){ const d = el('#cartDrawer'); if(!d) return; d.classList.add('open'); renderCartDrawer(); }
function closeCartDrawer(){ const d = el('#cartDrawer'); if(!d) return; d.classList.remove('open'); }
function renderCartDrawer(){ const body = el('#cartDrawerBody'); const foot = el('#cartDrawerFooter'); if(!body || !foot) return; if(state.cart.length===0){ body.innerHTML='<div class="muted">Your cart is empty.</div>'; foot.innerHTML=''; return; }
  // write body immediately (mostly static HTML) then batch footer update
  body.innerHTML = state.cart.map((it,idx)=>`<div class="item"><div style="width:64px;height:64px;overflow:hidden;border-radius:8px"><img src='${PRODUCTS.find(p=>p.id===it.id)?.img}' style='width:100%;height:100%;object-fit:cover'/></div><div class="meta"><div class="name">${it.name}</div><div class="muted mono" style="font-size:12px">${it.size} ‚Ä¢ ${it.qty} √ó ${pound(it.price)}</div></div><div><div class="mono">${pound(it.price*it.qty)}</div><div style="margin-top:6px"><button class="btn" onclick="incQty(${idx})">+</button> <button class="btn" onclick="decQty(${idx})">‚àí</button></div></div></div>`).join('');
  const subtotal = sum(state.cart);
  const shipping = subtotal>=100?0:4.95;
  const promo = state.promo || {};
  const discount = promo.discount||0;
  const discountAmt = typeof discount==='number' ? +(subtotal*(discount/100)).toFixed(2) : 0;
  const subAfter = +(subtotal - discountAmt).toFixed(2);
  const total = +(subAfter + shipping).toFixed(2);
  requestAnimationFrame(()=>{
    foot.innerHTML = `<div class="line"></div><div class="row-between"><div class="muted">Subtotal</div><div class="mono">${pound(subtotal)}</div></div><div class="row-between"><div class="muted">Discount</div><div class="mono">${discountAmt?'-'+pound(discountAmt):'-'}</div></div><div class="row-between"><div class="muted">Shipping</div><div class="mono">${shipping===0?'Free':pound(shipping)}</div></div><div class="hr"></div><div class="row-between"><div class="title">Total</div><div class="mono" style="font-weight:700">${pound(total)}</div></div><div style="margin-top:10px"><button class="btn full" onclick="go('checkout')">Go to checkout</button></div>`;
  });
}

function initUIAfterRender(){
  // update theme toggle label if present
  try{ updateThemeToggle(); }catch(e){}
  // ensure cartbar reflects state
  try{ updateCartBar(); }catch(e){}
  // wire search debounce and filters
  try{
    const q = document.getElementById('q');
    if(q){
      q.oninput = debounce(function(ev){ state.query = this.value; render(); },150);
      const clear = document.getElementById('clearSearch'); if(clear) clear.onclick = ()=>{ state.query=''; (document.getElementById('q')||{}).value=''; render(); };
    }
    const fs = document.getElementById('filterSize'); if(fs){ fs.onchange = ()=>{ state.filters.size = fs.value||null; render(); } }
    const fu = document.getElementById('filterUnder100'); if(fu){ fu.onclick = ()=>{ state.filters.under100 = !state.filters.under100; fu.classList.toggle('active', state.filters.under100); render(); } }
    const fi = document.getElementById('filterInStock'); if(fi){ fi.onclick = ()=>{ state.filters.inStock = !state.filters.inStock; fi.classList.toggle('active', state.filters.inStock); render(); } }
  }catch(e){console.warn('initUI filters',e)}
  // infinite scroll removed for simpler home
}

// Promo and address book helpers
state.promo = state.promo || null;
const PROMOS = { 'DRIP10':{type:'percent',discount:10}, 'SHIPFREE':{type:'shipping',discount:100} };
async function applyPromoCode(code){
  if(!code) return; const c = (code||'').toUpperCase().trim();
  // try server validation first (if endpoint exists), otherwise fallback to local PROMOS
  try{
    const res = await fetch(`/api/promos/validate`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code:c})});
    if(res && res.ok){ const json = await res.json(); if(json && json.valid){ state.promo = {code:c, discount: json.discount || 0, type: json.type || 'percent'}; haptic('impact'); render(); updateMainButtonTotal(); return; } }
  }catch(e){ /* ignore network errors and fallback */ }
  const meta = PROMOS[c]; if(!meta){ alert('Promo not recognised'); return; }
  state.promo = {code:c,discount:meta.discount,type:meta.type}; haptic('impact'); render(); updateMainButtonTotal();
}
function clearPromo(){ state.promo=null; render(); updateMainButtonTotal(); }

// Address book (localStorage)
function saveAddress(){ const address = {
  name: el('#f-name')?.value||'', phone: el('#f-phone')?.value||'', email: el('#f-email')?.value||'', address: el('#f-address')?.value||'', city: el('#f-city')?.value||'', postcode: el('#f-postcode')?.value||'', country: el('#f-country')?.value||'' };
  const list = load('addresses', []); list.unshift(address); while(list.length>5) list.pop(); save('addresses', list); alert('Address saved'); haptic('success');
}
function useSavedAddress(i){ const list = load('addresses', []); const a = list[i]; if(!a) return; el('#f-name').value = a.name||''; el('#f-phone').value = a.phone||''; el('#f-email').value = a.email||''; el('#f-address').value = a.address||''; el('#f-city').value = a.city||''; el('#f-postcode').value = a.postcode||''; el('#f-country').value = a.country||''; render(); }
function renderSavedAddresses(){ const list = load('addresses', []); if(!list.length) return '<div class="muted">No saved addresses</div>'; return list.map((a,i)=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0"><div><div class="mono">${a.name} ‚Ä¢ ${a.postcode}</div><div class="muted" style="font-size:12px">${a.address} ${a.city}</div></div><div><button class="btn" onclick="useSavedAddress(${i})">Use</button></div></div>`).join(''); }

// phone / postcode formatting + postcode -> city simple map
function formatPhone(v){ if(!v) return ''; const digits = v.replace(/\D/g,''); if(digits.length<=4) return digits; if(digits.length<=7) return digits.replace(/(\d{3})(\d+)/,'$1 $2'); if(digits.length<=11) return digits.replace(/(\d{3})(\d{3})(\d+)/,'$1 $2 $3'); return v; }
function formatPostcode(v){ if(!v) return ''; const t = v.toUpperCase().replace(/\s+/g,''); if(t.length>3) return t.slice(0,t.length-3)+' '+t.slice(-3); return t; }
const POSTCODE_MAP = { 'SW1A':'London','E1':'London','EC1A':'London','M1':'Manchester','L1':'Liverpool','G1':'Glasgow'};
function suggestCityFromPostcode(pc){ const p = (pc||'').toUpperCase().replace(/\s+/g,''); if(!p) return null; // try prefixes
  const prefixes = [p.slice(0,4),p.slice(0,3),p.slice(0,2)]; for(const pr of prefixes){ if(POSTCODE_MAP[pr]) return POSTCODE_MAP[pr]; }
  return null;
}

function updateMainButtonTotal(){ // recompute main button text with promo
  const subtotal = sum(state.cart); let shipping = subtotal>=100?0:4.95; let discountAmt = 0;
  if(state.promo){ if(state.promo.type==='percent'){ discountAmt = +(subtotal*(state.promo.discount/100)).toFixed(2);} else if(state.promo.type==='shipping'){ shipping = 0; } }
  const total = +(subtotal - discountAmt + shipping).toFixed(2);
  if(state.cart.length>0) setMainButton(`${state.promo?state.promo.code+' ‚Ä¢ ':''}Checkout ‚Äî ${pound(total)}`, ()=> go('checkout'));
}

/* ====== NAV ====== */
// route animation + helper controls
function animateRoute(fn){
  const app = el('#app');
  if(!app){ fn(); return; }
  app.classList.add('route-exit');
  setTimeout(()=>{
    fn();
    app.classList.remove('route-exit');
    app.classList.add('route-enter');
    setTimeout(()=>app.classList.remove('route-enter'), 200);
  }, 200);
}

// simple debounce
function debounce(fn, wait){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,args), wait); }; }

// Recently viewed management (localStorage)
function getRecent(){ try{ return load('recentViews', []); }catch(e){ return []; } }
function addRecent(id){ try{ const list = getRecent().filter(x=>x!==id); list.unshift(id); while(list.length>8) list.pop(); save('recentViews', list); }catch(e){} }

// infinite scroll removed (single-screen home)

// image helpers for lazy images with skeletons
function onImageLoad(img){
  try{ const sk = img.previousElementSibling; if(sk && sk.classList.contains('skeleton')) sk.remove(); img.classList.remove('hidden'); }
  catch(e){console.warn('img load handler',e)}
}
function onImageError(img){
  try{ img.src = PLACEHOLDER_IMG; img.classList.remove('hidden'); const sk = img.previousElementSibling; if(sk && sk.classList.contains('skeleton')) sk.remove(); }
  catch(e){console.warn('img error handler',e)}
}

// Long-press quick add helpers
let __longPressTimer = null;
function startLongPress(ev, id){
  try{ ev.preventDefault?.(); }catch(e){}
  cancelLongPress();
  __longPressTimer = setTimeout(()=>{ const elTarget = ev && ev.currentTarget ? ev.currentTarget : (ev && ev.target ? ev.target : null); showSizePicker(id, elTarget); }, 600);
}
function cancelLongPress(){ if(__longPressTimer){ clearTimeout(__longPressTimer); __longPressTimer = null; } }
// Show floating size picker near an element
function showSizePicker(id, anchorEl){
  const p = PRODUCTS.find(x=>x.id===id); if(!p) return;
  if(!(p.sizes && p.sizes.length)){ addToCartWithSize(id,'‚Äî'); render(); return; }
  let picker = el('#sizePicker');
  if(!picker){ picker = document.createElement('div'); picker.id='sizePicker'; picker.style.position='fixed'; picker.style.zIndex='200'; picker.style.minWidth='160px'; picker.style.background='var(--card)'; picker.style.border='1px solid var(--stroke)'; picker.style.borderRadius='12px'; picker.style.padding='8px'; picker.style.boxShadow='0 10px 40px rgba(0,0,0,.5)'; picker.innerHTML=''; document.body.appendChild(picker);
    picker.addEventListener('click',(ev)=>ev.stopPropagation());
  }
  picker.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div class="muted">Choose size</div><button class="btn" onclick="closeSizePicker()">‚úï</button></div><div style="display:flex;gap:8px;flex-wrap:wrap">${p.sizes.map(s=>`<button class="btn" style="padding:6px 8px" onclick="(function(){ addToCartWithSize('${id}','${s}'); closeSizePicker(); render(); })()">${s}</button>`).join('')}</div>`;
  // make picker keyboard accessible
  picker.setAttribute('tabindex','0');
  picker.querySelectorAll('button').forEach((b)=>{ b.setAttribute('tabindex','0'); });
  picker.onkeydown = function(e){
    const focusable = Array.from(this.querySelectorAll('button'));
    const idx = focusable.indexOf(document.activeElement);
    if(e.key === 'Escape'){ closeSizePicker(); return; }
    if(e.key === 'ArrowRight' || e.key === 'ArrowDown'){ e.preventDefault(); const ni = Math.min(focusable.length-1, Math.max(0, idx+1)); focusable[ni].focus(); }
    if(e.key === 'ArrowLeft' || e.key === 'ArrowUp'){ e.preventDefault(); const ni = Math.max(0, (idx<=0?0:idx-1)); focusable[ni].focus(); }
    if(e.key === 'Enter' && document.activeElement && document.activeElement.tagName==='BUTTON'){ document.activeElement.click(); }
  };
  // position near anchorEl if available
  if(anchorEl && anchorEl.getBoundingClientRect){
    try{
      const r = anchorEl.getBoundingClientRect();
      const top = Math.max(12, r.top + (window.scrollY||0) + 8);
      // default left near anchor left
      let left = Math.max(12, r.left + (window.scrollX||0));
      // compute a reasonable picker width and flip if required
      const pickerWidth = Math.min(320, Math.max(160, (p.sizes.length*80)));
      picker.style.width = pickerWidth + 'px';
      if((window.innerWidth - r.right) < (pickerWidth + 12)){
        left = Math.max(12, r.right + (window.scrollX||0) - pickerWidth);
      }
      picker.style.top = top + 'px'; picker.style.left = left + 'px';
    }catch(e){}
  } else { picker.style.top='120px'; picker.style.left='12px'; }
  // close on outside click
  setTimeout(()=>{ window.addEventListener('click', closeSizePicker); }, 40);
}
function closeSizePicker(){ const p = el('#sizePicker'); if(p){ p.remove(); } window.removeEventListener('click', closeSizePicker); }
function addToCartWithSize(id,size){
  const p = PRODUCTS.find(x=>x.id===id); if(!p) return;
  const ex = state.cart.find(i=>i.id===id && i.size===size);
  if(ex) ex.qty = Math.min(ex.qty+1,99); else state.cart.push({id,name:p.name,price:p.price,size,qty:1});
  save('cart',state.cart); haptic('rigid'); updateCartBar();
}

// Image modal + gallery helpers
window.__gallery = {images: [], index: 0};
function openImageModal(index=0){
  const g = window.__gallery; g.index = index; const overlay = el('#imgModal'); if(!overlay) return;
  const img = overlay.querySelector('img'); img.src = g.images[g.index]; overlay.classList.add('open');
}
function closeImageModal(){ const overlay = el('#imgModal'); if(!overlay) return; overlay.classList.remove('open'); }
function galleryNext(){ const g = window.__gallery; if(!g.images.length) return; g.index = (g.index+1)%g.images.length; openImageModal(g.index); }
function galleryPrev(){ const g = window.__gallery; if(!g.images.length) return; g.index = (g.index-1+g.images.length)%g.images.length; openImageModal(g.index); }
// simple swipe tracking on modal
let __swStartX = null;
function galleryTouchStart(e){ __swStartX = (e.touches && e.touches[0]?.clientX) || null; }
function galleryTouchMove(e){}
function galleryTouchEnd(e){ if(__swStartX==null) return; const endX = (e.changedTouches && e.changedTouches[0]?.clientX) || null; if(endX==null) return; const dx = endX - __swStartX; if(dx>40) galleryPrev(); else if(dx<-40) galleryNext(); __swStartX = null; }

// component: product card renderer
function productCard(p, opts={}){
  if(!p) return '';
  if(opts.compact){
    return `<div style="min-width:140px;max-width:160px;cursor:pointer" onclick="go('pdp',{id:'${p.id}'})" role="button" tabindex="0" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}" aria-label="${p.name}" onpointerdown="startLongPress(event,'${p.id}')" onpointerup="cancelLongPress()" onpointercancel="cancelLongPress()" onpointerleave="cancelLongPress()"><div class="card compact-card" style="padding:8px"><div style="height:90px;overflow:hidden;border-radius:8px"><div class="skeleton"></div><img class="img hidden" src="${p.img}" srcset="${p.img}&w=400 400w, ${p.img}&w=800 800w" sizes="140px" loading="lazy" onload="onImageLoad(this)" onerror="onImageError(this)" alt="${p.name}"/></div><div style="margin-top:8px"><div class="name" style="font-size:13px">${p.name}</div><div class="muted mono" style="font-size:12px">${pound(p.price)}</div></div></div></div>`;
  }
  return `
    <article class="card" role="button" tabindex="0" onclick="go('pdp',{id:'${p.id}'})" onpointerdown="startLongPress(event,'${p.id}')" onpointerup="cancelLongPress()" onpointercancel="cancelLongPress()" onpointerleave="cancelLongPress()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click()}" aria-label="${p.name}">
      <div style="position:relative;overflow:hidden;aspect-ratio:4/5;">
        <div class="skeleton"></div>
        <img class="img hidden" src="${p.img}" srcset="${p.img}&w=600 600w, ${p.img}&w=900 900w, ${p.img}&w=1200 1200w" sizes="(max-width:600px) 100vw, 220px" loading="lazy" onload="onImageLoad(this)" onerror="onImageError(this)" alt="${p.name}" />
      </div>
      <div class="pad">
        <div class="brand">${p.brand}</div>
        <div class="name">${p.name}</div>
        <div class="row-between">
          <div class="price">${pound(p.price)}</div>
          ${p.stock<=3?`<div class="low mono">Only ${p.stock} left</div>`:""}
        </div>
      </div>
    </article>
  `;
}

function loadingSkeletonHTML(n=4){
  let out=''; for(let i=0;i<n;i++){
    out += `<div class="skeleton-card"><div class="thumb"><div class="skeleton"></div></div><div class="meta"><div class="skeleton" style="height:14px;width:70%"></div></div></div>`;
  }
  return out;
}

// Theme handling: read Telegram themeParams when available and allow toggle
function applyThemeFromTelegram(){
  try{
    const params = tg.themeParams ?? {};
    // if Telegram indicates light scheme or background is light, prefer light
    const scheme = params.scheme || (params.bg_color && params.bg_color.startsWith('#f')) ? 'light' : 'dark';
    if(scheme==='light'){ document.documentElement.setAttribute('data-theme','light'); }
    else { document.documentElement.removeAttribute('data-theme'); }
    updateThemeToggle();
  }catch(e){}
}
function toggleTheme(){
  const cur = document.documentElement.getAttribute('data-theme')==='light' ? 'light' : 'dark';
  if(cur==='light'){ document.documentElement.removeAttribute('data-theme'); } else { document.documentElement.setAttribute('data-theme','light'); }
  updateThemeToggle();
}
function updateThemeToggle(){
  const b = document.getElementById('themeToggle'); if(!b) return; const isLight = document.documentElement.getAttribute('data-theme')==='light'; b.innerText = isLight ? 'üåô Dark' : '‚òÄÔ∏è Light';
}

// wire Telegram theme change event (if available)
try{ tg.onEvent?.('themeChanged', applyThemeFromTelegram); }catch(e){}

// use animateRoute wrapper for navigation so we get a small slide/opacity effect
function go(name,params={}){ animateRoute(()=>{ state.route={name,params}; render(); }); }

/* ====== RENDER ====== */
function render(){
  const app=el("#app");
  if(state.route.name==="home"){ renderHome(app); initUIAfterRender(); return; }
  if(state.route.name==="pdp"){ renderPDP(app,state.route.params.id); initUIAfterRender(); return; }
  if(state.route.name==="checkout"){ renderCheckout(app); initUIAfterRender(); return; }
  if(state.route.name==="confirm"){ renderConfirm(app); initUIAfterRender(); return; }
  if(state.route.name==="returns"){ renderReturns(app); initUIAfterRender(); return; }
}

function renderHome(app){
  setBack(false);
  // determine available categories (stock-aware)
  const activeCategories = CATEGORIES.filter(c=> PRODUCTS.some(p=>p.cat===c && p.stock>0));
  if(!activeCategories.includes(state.tab)) state.tab = activeCategories[0] || CATEGORIES[0];
  // build filtered product list: category -> subcategory -> query -> inStock
  const q = (state.query||"").trim().toLowerCase();
  let listAll = PRODUCTS.filter(p=>p.cat===state.tab && p.stock>0);
  if(state.subTab && state.subTab !== 'All'){ listAll = listAll.filter(p=> (p.type||'').toLowerCase() === state.subTab.toLowerCase()); }
  if(q){ listAll = listAll.filter(p=> (p.name||'').toLowerCase().includes(q) || (p.brand||'').toLowerCase().includes(q)); }
  if(state.filters.inStock){ listAll = listAll.filter(p=>p.stock>0); }

  // category chips
  const cats = activeCategories.map(c=>`<button class="cat-chip ${c===state.tab? 'active':''}" onclick="(function(){ state.tab='${c}'; state.subTab='All'; render(); })()">${c}</button>`).join('');
  // subcategory chips for active tab
  const subs = (SUBCATEGORIES[state.tab]||['All']).filter(s=>{
    if(s==='All') return true;
    return PRODUCTS.some(p=>p.cat===state.tab && (p.type||'')===s && p.stock>0);
  }).map(s=>`<button class="sub-chip ${state.subTab===s? 'active':''}" onclick="(function(){ state.subTab='${s}'; render(); })()">${s}</button>`).join('');

  const grid = listAll.map(p=>productCard(p)).join('') || `<div class="muted" style="grid-column:1/-1">No items match ‚Äú${state.query}‚Äù.</div>`;

  app.innerHTML = `
    <header>
      <div class="row">
        <div style="display:flex;align-items:center;gap:8px"><div class="logo">DC</div><div class="title">Drip Club</div></div>
        <div class="grow"></div>
        <div style="display:flex;gap:8px;align-items:center">
          <a class="link" href="${SUPPORT_LINK}">Support</a>
        </div>
      </div>
      <div style="margin-top:10px;font-size:13px;color:var(--muted);display:flex;gap:12px;align-items:center">‚úÖ Verified stock ¬∑ ‚Ü© 30-day returns ¬∑ üí¨ Telegram support</div>
    </header>

    <div class="section">
      <div class="cat-row">${cats}</div>
      <div class="sub-row">${subs}</div>
      <div style="margin-top:10px;display:flex;gap:8px"><input id="q" placeholder="Search brand or item‚Ä¶" value="${state.query||''}" style="flex:1" /><button class="btn" id="clearSearch">Clear</button></div>

      <div class="grid" style="margin-top:12px">${grid}</div>

      <div class="help" style="margin-top:10px">Returns & Delivery ‚Üí <a class="link" href="#" onclick="go('returns')">Read policy</a></div>
    </div>`;

  updateCartBar();
  if(state.cart.length>0){ setMainButton(`Checkout ‚Äî ${pound(sum(state.cart))}`, ()=> go("checkout")); } else hideMain();
}

function renderPDP(app,id){
  const p=PRODUCTS.find(x=>x.id===id); if(!p){go("home");return}
  setBack(true,()=>go("home"));
  // record recently viewed
  try{ addRecent(p.id); }catch(e){}
  const sel=(p.sizes&&p.sizes.length?p.sizes[0]:"‚Äî");
  app.innerHTML=
    `<header><div class="row"><div style="display:flex;align-items:center;gap:8px"><div class="logo">DC</div><div class="title">Drip Club</div></div><div class="grow"></div><div style="display:flex;gap:8px;align-items:center">${orderBadge()}<button id="themeToggle" class="btn secondary" onclick="toggleTheme()">Theme</button><a class="link" href="${SUPPORT_LINK}">Support</a></div></div></header>
    <div class="section">
      <div class="box">
        <div class="gallery" style="position:relative;overflow:hidden;aspect-ratio:4/5;margin-bottom:10px">
          <div class="skeleton"></div>
          ${((p.images && p.images.length)?p.images:[p.img]).map((src,i)=>`<img class="img hidden gallery-img" data-index="${i}" src="${src}" loading="lazy" onload="onImageLoad(this)" onerror="onImageError(this)" onclick="openImageModal(${i})" alt="${p.name} ${i+1}" />`).join('')}
        </div>
  <div class="row-between" style="margin-top:10px"><div style="display:flex;flex-direction:column"><div class="name" style="font-size:16px">${p.name}</div><div class="muted" style="font-size:13px">ETA: ${p.stock>0? '2‚Äì4 business days':'7‚Äì14 days (pre-order)'} ‚Ä¢ 30-day returns</div></div><div class="price mono">${pound(p.price)}</div></div>
        ${p.stock<=3?`<div class="low">Only ${p.stock} left</div>`:""}
        <div class="field"><label class="muted">Size</label><select id="size">${p.sizes.map(s=>`<option ${s===sel?"selected":""}>${s}</option>`).join("")}</select></div>
        <div class="stock-meter-wrap"><div class="stock-meter" style="width:${Math.min(100,(p.stock||0)*10)}%"></div><div class="stock-label">${p.stock>3? 'In stock':'Low stock'}</div></div>
        <p class="muted" style="font-size:13px">Authenticity guaranteed. Verified designs only.</p>
        <div class="hr"></div>
        <button class="btn full" onclick="addToCart('${p.id}')">Add to Cart</button>
        <div class="help">Need help? <a class="link" href="${SUPPORT_LINK}">Chat to support</a></div>
      </div>
    </div>`;
  // set gallery images for modal functions
  window.__gallery.images = (p.images && p.images.length) ? p.images : [p.img];
  setMainButton(`Checkout ‚Äî ${pound(sum(state.cart))}`,()=> state.cart.length?go("checkout"):addToCart(p.id));
  updateCartBar();
}

function addToCart(id){
  const p=PRODUCTS.find(x=>x.id===id); if(!p)return;
  const sel=el("#size")?.value??(p.sizes?.[0]??"‚Äî");
  const ex=state.cart.find(i=>i.id===id&&i.size===sel);
  if(ex){ex.qty=Math.min(ex.qty+1,99);}else{state.cart.push({id,name:p.name,price:p.price,size:sel,qty:1});}
  save("cart",state.cart); haptic("rigid"); updateCartBar();
  setMainButton(`Checkout ‚Äî ${pound(sum(state.cart))}`,()=>go("checkout"));
}

function renderCartList(){
  if(state.cart.length===0) return `<div class="muted">Cart is empty.</div>`;
  return `<div class="list">${state.cart.map((it,idx)=>`
    <div class="box">
      <div class="row-between">
        <div><div class="name">${it.name}</div><div class="muted mono" style="font-size:12px">${it.size}</div></div>
  <div class="mono">${pound(it.price*it.qty)}</div>
      </div>
      <div class="row-between" style="margin-top:8px">
        <div class="qty">
          <button onclick="decQty(${idx})">‚àí</button>
          <div class="mono">${it.qty}</div>
          <button onclick="incQty(${idx})">+</button>
        </div>
        <button class="btn" onclick="removeItem(${idx})">Remove</button>
      </div>
    </div>`).join("")}</div>`;
}
function incQty(i){state.cart[i].qty=Math.min(state.cart[i].qty+1,99);save("cart",state.cart);render();}
function decQty(i){state.cart[i].qty=Math.max(state.cart[i].qty-1,1);save("cart",state.cart);render();}
function removeItem(i){const removed=state.cart.splice(i,1)[0];save("cart",state.cart);render();toastUndo(removed);}
function toastUndo(item){
  haptic("soft"); const n=document.createElement("div");
  n.className="box"; n.style.position="fixed"; n.style.left="12px"; n.style.right="12px"; n.style.bottom="72px"; n.style.zIndex="60";
  n.innerHTML=`<div class="row-between"><div>Removed <span class="mono">${item.name}</span></div><button class="btn" id="undo">Undo</button></div>`;
  document.body.appendChild(n); let t=setTimeout(()=>n.remove(),3000);
  n.querySelector("#undo").onclick=()=>{clearTimeout(t);state.cart.push(item);save("cart",state.cart);n.remove();render();};
}

/* ====== CHECKOUT / CONFIRM / RETURNS (unchanged core) ====== */
function renderCheckout(app){
  if(state.cart.length===0){go("home");return}
  setBack(true,()=>go("home"));
  const subtotal=sum(state.cart); const shipping=subtotal>=100?0:4.95; const total=+(subtotal+shipping).toFixed(2);
  // apply promo if any
  let promoDiscount = 0; let promoNote = '';
  if(state.promo){ if(state.promo.type==='percent'){ promoDiscount = +(subtotal*(state.promo.discount/100)).toFixed(2); promoNote = `${state.promo.code} ‚àí${state.promo.discount}%`; } else if(state.promo.type==='shipping'){ shipping = 0; promoNote = `${state.promo.code} (free shipping)`; } }
  const after = +(subtotal - promoDiscount + shipping).toFixed(2);
  if(!state.hold){state.hold={expiresAt:Date.now()+45*60*1000};}
  const left=Math.max(0,Math.floor((state.hold.expiresAt-Date.now())/1000));
  const ref=state.order?.uniqueRef??uniqueRef();
  app.innerHTML=`
    <header><div class="row"><div style="display:flex;align-items:center;gap:8px"><div class="logo">DC</div><div class="title">Drip Club</div></div><div class="grow"></div><div style="display:flex;gap:8px;align-items:center">${orderBadge()}<button id="themeToggle" class="btn secondary" onclick="toggleTheme()">Theme</button><a class="link" href="${SUPPORT_LINK}">Support</a></div></div></header>
    <div class="section">
      <div class="box">
        <div class="row-between"><div class="title">Your bag</div><a class="link" href="#" onclick="go('home')">Add more</a></div>
        ${renderCartList()}
        <div class="hr"></div>
  <div class="row-between"><div class="muted">Subtotal</div><div class="mono">${pound(subtotal)}</div></div>
  <div class="row-between"><div class="muted">Shipping</div><div class="mono">${shipping===0?"Free":pound(shipping)}</div></div>
  <div class="row-between" style="margin-top:8px"><div>Total</div><div class="mono" style="font-weight:700">${pound(total)}</div></div>
        <div class="help mono">We‚Äôll reserve these for <span id="hold">00:00</span> while you pay.</div>
      </div>

      <div class="box">
        <div class="title" style="font-size:16px">Contact & Delivery</div>
        ${["email","phone","name","address","city","postcode"].map(k=>`
          <div class="field"><label class="muted">${k[0].toUpperCase()+k.slice(1)}</label>
          <input id="f-${k}" value="${state.user[k]??""}" placeholder="${k==='email'?'you@example.com':''}" ${k==='phone'?`oninput="this.value=formatPhone(this.value)"`:''} ${k==='postcode'?`oninput="this.value=formatPostcode(this.value); const s=suggestCityFromPostcode(this.value); if(s) document.getElementById('f-city').value=s;"`:''} /></div>`).join("")}
        <div class="field"><label class="muted">Country</label><input id="f-country" value="${state.user.country}"/></div>
        <div style="margin-top:6px"> <div class="muted" style="font-size:13px">Saved addresses</div> <div id="savedAddresses">${renderSavedAddresses()}</div> <div style="margin-top:8px"><button class="btn" onclick="saveAddress()">Save current address</button></div></div>
      </div>

      <div class="box">
        <div class="row-between"><div class="title" style="font-size:16px">Pay by bank</div></div>
        <div style="display:flex;gap:8px;margin-bottom:8px"><input id="promoCode" placeholder="Promo code" style="flex:1;border-radius:12px;padding:10px;border:1px solid var(--stroke)"/><button class="btn" onclick="applyPromoCode(document.getElementById('promoCode').value)">Apply</button></div>
        ${state.promo?`<div class="muted">Applied: <b>${state.promo.code}</b> ${promoNote}</div>`:''}
          <button class="btn full" style="margin-bottom:10px" onclick="openBankingPay(${after}, '${ref}')">Pay by bank (Open Banking)</button>
          <div class="help">Or pay manually using your banking app. Include the reference below so we can auto-match your payment.</div>
          <div class="muted" style="margin-top:6px">Bank transfer fees: None (Drip does not charge). Your bank may apply fees.</div>
          ${copyRow("Payee",BANK.payee)}
          ${copyRow("Sort code",BANK.sortCode)}
          ${copyRow("Account no.",BANK.accountNo)}
          ${copyRow("IBAN",BANK.iban)}
          ${copyRow("Amount",pound(after), String(after))}
          ${copyRow("Unique reference",ref, ref, "ref")}
          <div style="display:flex;gap:8px;margin-top:8px"><button class="btn" onclick="copyPaymentAll(${after}, '${ref}')">Copy all</button><button class="btn" onclick="(function(){ const t = copyPaymentAll(${after}, '${ref}'); window.open('https://t.me/share/url?text='+encodeURIComponent(t)); })()">Message support</button></div>
          <div class="help">Questions about payment? <a class="link" href="${SUPPORT_LINK}">Chat to support</a></div>
      </div>

      <div class="box">
        <div class="row-between"><div class="title" style="font-size:16px">After you‚Äôve paid</div></div>
        <div class="help">Tap the button below. We‚Äôll verify and update your order here.</div>
        <div class="field"><label class="muted">Upload proof (optional)</label><input type="file" id="proof" accept="image/*,application/pdf"/></div>
        <button class="btn full" onclick="placeOrder(${after}, '${ref}')">I‚Äôve paid ‚Äî place order</button>
        <div class="help">Returns? See <a class="link" href="#" onclick="go('returns')">policy</a>.</div>
      </div>
    </div>`;
  setMainButton(`${state.promo?state.promo.code+' ‚Ä¢ ':''}Checkout ‚Äî ${pound(after)}`,()=>document.querySelector("button.btn.full")?.click());
  updateCartBar(); tickHold(left);
  // start polling order status if we have an active order
  try{ if(state.order?.id) pollOrderStatus(state.order.id); else if(load('lastOrder')?.id) pollOrderStatus(load('lastOrder').id); }catch(e){}
}
function renderConfirm(app){
  setBack(false);
  const o=state.order??load("lastOrder",null); if(!o){go("home");return}
  app.innerHTML=`
    <header><div class="row"><div style="display:flex;align-items:center;gap:8px"><div class="logo">DC</div><div class="title">Drip Club</div></div><div class="grow"></div><div style="display:flex;gap:8px;align-items:center">${orderBadge()}<button id="themeToggle" class="btn secondary" onclick="toggleTheme()">Theme</button><a class="link" href="${SUPPORT_LINK}">Support</a></div></div></header>
    <div class="section">
      <div class="box">
        <div class="row-between"><div class="title" style="font-size:16px">Thanks ‚Äî we‚Äôll verify your transfer</div><div class="pill">Under review</div></div>
        <div class="help">We match by amount and your unique reference below. You‚Äôll get updates here.</div>
        <div id="order-status" style="margin-top:8px"></div>
        ${copyRow("Order",o.id,o.id)}
        ${copyRow("Unique reference",o.uniqueRef,o.uniqueRef)}
        <div style="margin-top:10px;display:flex;gap:8px"><button class="btn" onclick="startReturnChat('${o.id}')">Start return</button><a class="btn" href="${_chatPayloadFor('confirm', o.uniqueRef).tgDeep}" target="_blank">Message about this order</a></div>
      </div>
      <div class="box">
        <div class="title" style="font-size:16px">Summary</div>
  ${o.items.map(it=>`<div class="row-between"><div>${it.name} <span class="muted">(${it.size})</span> √ó ${it.qty}</div><div class="mono">${pound(it.qty*it.price)}</div></div>`).join("")}
        <div class="hr"></div>
  <div class="row-between"><div class="muted">Subtotal</div><div class="mono">${pound(o.subtotal)}</div></div>
  <div class="row-between"><div class="muted">Shipping</div><div class="mono">${pound(o.shipping)}</div></div>
  <div class="row-between" style="margin-top:8px"><div>Total</div><div class="mono" style="font-weight:700">${pound(o.total)}</div></div>
      </div>
      <div class="box">
        <div class="help">Need anything else?</div>
        <div class="row" style="gap:8px">
          <a class="btn grow" href="#" onclick="go('home')">Continue shopping</a>
          <a class="btn grow" href="${SUPPORT_LINK}">Message about this order</a>
        </div>
      </div>
    </div>`;
  hideMain(); updateCartBar();
}
function renderReturns(app){
  setBack(true,()=>go("home"));
  app.innerHTML=`
    <header><div class="row"><div style="display:flex;align-items:center;gap:8px"><div class="logo">DC</div><div class="title">Drip Club</div></div><div class="grow"></div><div style="display:flex;gap:8px;align-items:center">${orderBadge()}<button id="themeToggle" class="btn secondary" onclick="toggleTheme()">Theme</button></div></div></header>
    <div class="section"><div class="box">
      <p>Returns within <b>30 days</b> in original condition. Email receipts are required.</p>
      <p>To start a return, message us: <a class="link" href="${SUPPORT_LINK}">Open chat</a> and include your order ID.</p>
      <p>Delivery: Standard 2‚Äì4 business days; Express 1‚Äì2 business days.</p>
    </div></div>`;
  hideMain();
}

/* ====== Bits ====== */
function copyRow(label,value,rawCopy,id){
  const cp = (rawCopy!==undefined ? rawCopy : value);
  return `<div class="copy"><div><div class="muted">${label}</div><div class="mono" ${id?`id="${id}"`:""}>${value}</div></div><button onclick="copy('${String(cp).replace(/'/g,"\\'")}', this)">Copy</button></div>`;
}
// Compose and copy all payment details (returns composed text)
function copyPaymentAll(amount, ref){
  try{
    const amt = typeof amount === 'number' ? pound(amount) : amount;
    const lines = [
      `Payee: ${BANK.payee}`,
      `Sort code: ${BANK.sortCode}`,
      `Account no.: ${BANK.accountNo}`,
      `IBAN: ${BANK.iban}`,
      `Amount: ${amt}`,
      `Reference: ${ref}`
    ];
    const txt = lines.join('\n');
    navigator.clipboard.writeText(txt).then(()=>{ haptic('soft'); alert('Payment details copied to clipboard'); }).catch(()=>{ alert('Could not copy to clipboard'); });
    return txt;
  }catch(e){ return ''; }
}

// Render a small order badge for headers and other places
function orderBadge(){
  try{
    const last = state.order?.uniqueRef || load('lastOrder')?.uniqueRef || null;
    if(!last) return '';
    return `<div class="pill mono" style="margin-left:8px">Ref: ${last}</div>`;
  }catch(e){return ''}
}
// Chat & returns helpers
function _chatPayloadFor(route, ref){
  const bot = 'YOUR_BOT_USERNAME';
  const payload = `${route}|${ref||''}`;
  const tgDeep = `tg://resolve?domain=${bot}&start=${encodeURIComponent(payload)}`;
  const webDeep = `https://t.me/${bot}?start=${encodeURIComponent(payload)}`;
  const shareText = `Support request\nRoute: ${route}\nRef: ${ref || ''}\n\nDescribe your request here...`;
  const shareUrl = `https://t.me/share/url?text=${encodeURIComponent(shareText)}`;
  return {bot, payload, tgDeep, webDeep, shareText, shareUrl};
}

function createChatPill(){
  try{
    if(document.getElementById('chatPill')) return;
    const pill = document.createElement('a');
    pill.id = 'chatPill';
    pill.className = 'chat-pill';
    pill.style.position = 'fixed';
    pill.style.right = '12px';
    pill.style.bottom = '84px';
    pill.style.zIndex = '220';
    pill.style.width = '56px';
    pill.style.height = '56px';
    pill.style.borderRadius = '999px';
    pill.style.display = 'flex';
    pill.style.alignItems = 'center';
    pill.style.justifyContent = 'center';
    pill.style.boxShadow = '0 8px 24px rgba(0,0,0,.35)';
    pill.style.background = 'linear-gradient(180deg,var(--brand),var(--brand2))';
    pill.style.color = '#fff';
    pill.style.textDecoration = 'none';
    pill.style.fontSize = '22px';
    pill.title = 'Chat to support';
    const ref = state.order?.uniqueRef || load('lastOrder')?.uniqueRef || '';
    const route = state.route?.name || 'home';
    const link = _chatPayloadFor(route, ref);
    // prefer tg deep link, fallback to web link if protocol not supported
    pill.href = link.tgDeep;
    pill.setAttribute('target','_blank');
    pill.innerHTML = 'üí¨';
    pill.onclick = function(ev){
      // attempt to open tg:// if available; browsers will fallback to https
      try{ haptic('soft'); }catch(e){}
    };
    document.body.appendChild(pill);
  }catch(e){console.warn('chat pill',e)}
}

function startReturnChat(orderId){
  try{
    const tpl = `Return request\nOrder ID: ${orderId}\nReason: \nPhotos: (attach)\n\nPlease advise next steps.`;
    const share = `https://t.me/share/url?text=${encodeURIComponent(tpl)}`;
    // also attempt to open bot with payload so bot can capture the return flow
    const bot = 'YOUR_BOT_USERNAME';
    const payload = `return|${orderId}`;
    const botDeep = `tg://resolve?domain=${bot}&start=${encodeURIComponent(payload)}`;
    // open share URL in a new tab (works cross-platform)
    window.open(share,'_blank');
  }catch(e){console.warn('startReturnChat',e)}
}

// Poll order status from server (or localStorage fallback) and update UI
let __orderPoll = null;
function pollOrderStatus(orderId){
  try{
    if(!orderId) return;
    if(__orderPoll) clearInterval(__orderPoll);
    let attempts = 0;
    __orderPoll = setInterval(async ()=>{
      attempts++;
      // try server endpoint first
      try{
        const res = await fetch(`/api/orders/${encodeURIComponent(orderId)}/status`);
        if(res && res.ok){ const json = await res.json(); if(json && json.status){ state.order = state.order || {}; state.order.status = json.status; state.order.payment = state.order.payment || {}; state.order.payment.status = json.paymentStatus || state.order.payment.status; updateOrderStatusDisplay(state.order); save('lastOrder', state.order); return; } }
      }catch(e){ /* ignore network */ }
      // fallback: check localStorage lastOrder
      try{ const lo = load('lastOrder', null); if(lo && lo.id===orderId){ state.order = lo; updateOrderStatusDisplay(state.order); return; } }catch(e){}
      // stop after many attempts
      if(attempts>30){ clearInterval(__orderPoll); __orderPoll=null; }
    }, 6000);
  }catch(e){console.warn('pollOrderStatus',e)}
}

function updateOrderStatusDisplay(order){
  try{
    const elStatus = document.getElementById('order-status');
    if(!elStatus) return;
    const s = (order?.status || order?.payment?.status || '').toUpperCase();
    let label = 'Unknown'; let cls = 'muted';
    if(/AWAITING|PENDING|AWAITING_PAYMENT/.test(s)) { label='Awaiting payment'; cls='low'; }
    else if(/AWAITING_REVIEW|AWAITING_PROVIDER/.test(s)) { label='Awaiting review'; cls='low'; }
    else if(/MATCHED|PAID|CONFIRMED/.test(s)) { label='Matched'; cls='ok'; }
    else if(/SHIPPED|DISPATCHED/.test(s)) { label='Shipped'; cls='ok'; }
    else if(/CANCELLED|REFUNDED/.test(s)) { label='Cancelled'; cls='danger'; }
    elStatus.innerHTML = `<div class="row-between"><div class="muted">Status</div><div class="mono ${cls}" style="font-weight:700">${label}</div></div>`;
  }catch(e){console.warn('updateOrderStatusDisplay',e)}
}
function tickHold(seconds){
  function fmt(s){const m=String(Math.floor(s/60)).padStart(2,"0");const ss=String(s%60).padStart(2,"0");return `${m}:${ss}`;}
  const n=el("#hold"); if(!n) return; let s=seconds; n.innerText=fmt(s);
  const footer = el('#holdFooter'); if(footer) footer.innerText = fmt(s);
  // warn once when under 2 minutes
  state._holdWarn = state._holdWarn || false;
  if(!state._holdWarn && s<=120){ haptic('warning'); state._holdWarn = true; }
  const id=setInterval(()=>{s=Math.max(0,s-1);n.innerText=fmt(s); if(footer) footer.innerText = fmt(s); if(s===0){clearInterval(id);state.hold=null;} if(!state._holdWarn && s<=120){ haptic('warning'); state._holdWarn = true; } },1000);
}
function openBankingPay(amount,ref){
  state.order={id:`O-${Date.now()}`,uniqueRef:ref,items:state.cart,subtotal:+sum(state.cart).toFixed(2),shipping:+(sum(state.cart)>=100?0:4.95).toFixed(2),total:+amount.toFixed(2),user:{...state.user},payment:{method:"open_banking",status:"AWAITING_PROVIDER"},status:"AWAITING_PAYMENT",proof:null};
  save("lastOrder",state.order); haptic("soft"); alert("Open Banking placeholder: your bank app would open.\nReturning to order confirmation‚Ä¶");
  fetch("/api/orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(state.order)}).catch(()=>{});
  state.cart=[]; save("cart",state.cart); go("confirm");
}
async function placeOrder(total,ref){
  ["email","phone","name","address","city","postcode","country"].forEach(k=>{state.user[k]=el("#f-"+k)?.value?.trim()??state.user[k];});
  const order={id:`O-${Date.now()}`,uniqueRef:ref||el("#ref")?.innerText||uniqueRef(),items:state.cart,subtotal:+sum(state.cart).toFixed(2),shipping:+(sum(state.cart)>=100?0:4.95).toFixed(2),total:+(+total||sum(state.cart)).toFixed(2),user:{...state.user},payment:{method:"bank_transfer",status:"AWAITING_REVIEW"},status:"AWAITING_PAYMENT",proof:null};
  const file=el("#proof")?.files?.[0]; if(file){order.proof={name:file.name,size:file.size,type:file.type};}
  try{await fetch("/api/orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(order)});}catch(e){}
  state.order=order; save("lastOrder",order); state.cart=[]; save("cart",state.cart); haptic("soft"); go("confirm");
}

/* ====== INIT ====== */
(function init(){ tg.ready?.(); tg.expand?.(); try{ applyThemeFromTelegram(); }catch(e){}; go("home");
  // defer non-critical, heavier UI setup to idle time to avoid blocking render
  const idle = window.requestIdleCallback || function(cb){ return setTimeout(cb, 200); };
  idle(()=>{ try{ createChatPill(); }catch(e){console.warn('idle init',e)} });
})();
</script>
</body>
</html>
